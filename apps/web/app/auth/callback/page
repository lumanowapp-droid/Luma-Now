import { headers } from 'next/headers'
import { createServerSupabaseClient } from '../../../lib/supabase'
import { redirect } from 'next/navigation'

export default async function AuthCallbackPage({
  searchParams,
}: {
  searchParams: Promise<{ [key: string]: string | string[] | undefined }>
}) {
  const supabase = await createServerSupabaseClient()
  const headersList = await headers()
  const host = headersList.get('host') || 'localhost:3000'
  const protocol = headersList.get('x-forwarded-proto') || 'http'

  const params = await searchParams

  console.log('[CALLBACK] Starting OAuth callback processing on server')
  console.log('[CALLBACK] Search params:', params)
  console.log('[CALLBACK] Host:', host)
  console.log('[CALLBACK] Protocol:', protocol)

  try {
    // First, handle the OAuth code exchange if present
    if (params.code) {
      console.log('[CALLBACK] Exchanging OAuth code for session')
      const { data, error } = await supabase.auth.exchangeCodeForSession(params.code as string)
      
      if (error) {
        console.error("[CALLBACK] OAuth exchange error:", error)
        return (
          <div className="min-h-screen flex items-center justify-center bg-gray-50">
            <div className="text-center">
              <h2 className="text-xl font-semibold text-red-600 mb-4">Authentication Error</h2>
              <p className="text-gray-600 mb-4">There was an error during authentication: {error.message}</p>
              <a href="/auth/signin" className="text-blue-600 hover:underline">
                Return to Sign In
              </a>
            </div>
          </div>
        )
      }

      console.log('[CALLBACK] OAuth exchange successful, user:', data.user?.email)
    }

    // Now check for the session
    const { data: { session }, error: sessionError } = await supabase.auth.getSession()

    if (sessionError) {
      console.error("[CALLBACK] Session error:", sessionError)
      return (
        <div className="min-h-screen flex items-center justify-center bg-gray-50">
          <div className="text-center">
            <h2 className="text-xl font-semibold text-red-600 mb-4">Session Error</h2>
            <p className="text-gray-600 mb-4">There was an error retrieving the session: {sessionError.message}</p>
            <a href="/auth/signin" className="text-blue-600 hover:underline">
              Return to Sign In
            </a>
          </div>
        </div>
      )
    }

    // Check if we have a session after the OAuth flow
    if (session) {
      console.log('[CALLBACK] Authentication successful, session found for user:', session.user.email)
      console.log('[CALLBACK] Redirecting to dashboard...')
      
      // Don't use redirect inside try-catch - let it bubble up naturally
      redirect('/dashboard')
    } else {
      console.log('[CALLBACK] No session found after OAuth flow')
      return (
        <div className="min-h-screen flex items-center justify-center bg-gray-50">
          <div className="text-center">
            <h2 className="text-xl font-semibold text-gray-800 mb-4">No Session Found</h2>
            <p className="text-gray-600 mb-4">No valid session was found after authentication.</p>
            <a href="/auth/signin" className="text-blue-600 hover:underline">
              Return to Sign In
            </a>
          </div>
        </div>
      )
    }
  } catch (err) {
    // Handle any unexpected errors (but NOT NEXT_REDIRECT)
    if (err instanceof Error && err.message.includes('NEXT_REDIRECT')) {
      throw err // Re-throw NEXT_REDIRECT to let Next.js handle it
    }
    
    console.error("[CALLBACK] Unexpected OAuth error:", err)
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-50">
        <div className="text-center">
          <h2 className="text-xl font-semibold text-red-600 mb-4">Unexpected Error</h2>
          <p className="text-gray-600 mb-4">An unexpected error occurred during authentication.</p>
          <a href="/auth/signin" className="text-blue-600 hover:underline">
            Return to Sign In
          </a>
        </div>
      </div>
    )
  }
}